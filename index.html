<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Circle of the Dark Forest</title>

<!-- Font Texturina (c√≥ Vietnamese) -->
<link href="https://fonts.googleapis.com/css2?family=Texturina:wght@400;700;900&display=swap&subset=vietnamese" rel="stylesheet">

<style>
:root{
  --bg1:url('');
  --bg2:url('');
  --bg3:url('');
  --font-heading:"Texturina", ui-serif, Georgia, serif;
  --font-body:"Texturina", ui-serif, Georgia, serif;

  --ink:#ece9ff; --muted:#b9b3de;
  --glass:rgba(30,20,62,.55); --border:#4b3d80aa;
  --accent-1:#ff6aa3; --accent-2:#9b6bff;
  --good:#2be9d4; --warn:#ffd76a; --bad:#ff6a8e;

  /* Icon welcome responsive (to g·∫•p 5 l·∫ßn ~ 420px) */
  --welcome-icon-min: 140px;
  --welcome-icon-max: 420px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink); font-family:var(--font-body);
  background:
    linear-gradient(180deg,#0a0e18aa,#0a0e18aa),
    var(--bg1) center/cover fixed no-repeat;
  display:grid; place-items:center;
}
body::before{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(1000px 600px at 55% 0%, #82cfff22, transparent 60%),
    radial-gradient(900px 520px at 20% 120%, #0aa0ff14, transparent 60%);
}

.app{
  width:min(1200px,96vw);
  padding:18px; border-radius:24px;
  background:var(--glass); border:1px solid var(--border);
  box-shadow:0 24px 90px #000b, inset 0 0 0 1px #ffffff08;
  backdrop-filter: blur(10px) saturate(120%);
  -webkit-backdrop-filter: blur(10px) saturate(120%);
}

.grid{ display:grid; grid-template-columns: 1fr 320px; gap:16px; }
@media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

h1{
  margin:2px 0 6px; font-family:var(--font-heading); font-weight:900;
  letter-spacing:.5px; font-size:clamp(22px,2.6vw,30px);
  text-shadow:0 2px 0 #0008, 0 0 22px #7c5dff55;
}
.story{ color:var(--muted); margin:6px 0 12px; max-width:100%; }

.hud{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
.badge{
  padding:7px 11px; border-radius:999px;
  background:linear-gradient(180deg,#19143b,#140f2f);
  border:1px solid #3c2f71; font-size:13px; box-shadow:inset 0 1px 0 #ffffff0d;
}

button{
  appearance:none; cursor:pointer; font-weight:700; color:#fff;
  border-radius:999px; padding:10px 16px; border:1px solid #ff9bd6aa;
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
  box-shadow:0 8px 24px #0007; transition:transform .12s, box-shadow .12s, filter .12s;
}
button:hover{transform:translateY(-1px); box-shadow:0 10px 28px #0008, 0 0 24px 2px #c891ff33}
button:active{transform:translateY(0); filter:brightness(.95)}
button.ghost{background:#19133e; border:1px solid #3f2f74}
button.pill{padding:12px 18px; font-size:15px}

.range{
  appearance:none; width:160px; height:6px; border-radius:999px; outline:none;
  background:linear-gradient(90deg,#ffffff55,#ffffff22);
}
.range::-webkit-slider-thumb{appearance:none; width:16px; height:16px; border-radius:50%;
  background:linear-gradient(135deg,var(--accent-1),var(--accent-2)); border:1px solid #fff3; box-shadow:0 0 10px #c891ff77}

/* Stage */
.stage{
  position:relative; border-radius:16px; overflow:hidden;
  border:1px solid #3b2d6d; box-shadow:0 14px 50px #000a;
  background:
    linear-gradient(180deg,#0b0f2acc,#0b0f2a88),
    var(--bg2) center/cover no-repeat;
}
canvas{
  display:block; width:100%; height:auto; background:transparent;
  border-radius:16px; touch-action:none; outline:1px solid #ffffff0a;
}

.ready-overlay{
  position:absolute; inset:0; display:grid; place-items:center;
  background:#0006; -webkit-backdrop-filter: blur(2px); backdrop-filter: blur(2px); z-index:5;
}
.center-acc{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  font: 900 clamp(28px,5vw,64px) var(--font-heading);
  color:#fff; text-shadow:0 0 16px #7c5dff, 0 0 28px #9b6bff, 0 3px 0 #0009;
  pointer-events:none; opacity:0; transition:opacity .12s;
}

/* Round bar */
.roundbar{ margin:10px 0 0; font-weight:700; }
.roundbar .grid10{ display:grid; grid-template-columns:repeat(10, 1fr); column-gap:8px; }
.roundbar .cell{
  text-align:center; background:#120f2e; border:1px solid #2d275b; border-radius:8px;
  padding:6px 4px; color:#d9d3ff; font-size:13px;
}
.roundbar .labels .cell{ background:#17123a; color:#e9e6ff; }

/* Score glow effects */
.score-red { color: #ff6a8e; text-shadow: 0 0 8px #ff6a8e; }
.score-green { color: #2be9d4; text-shadow: 0 0 8px #2be9d4; }
.score-purple { color: #9b6bff; text-shadow: 0 0 8px #9b6bff; }
.score-100 { color: #000; text-shadow: 0 0 8px #fff, 0 0 16px #fff; background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); }

/* Sidebar */
.sidebar{
  border:1px solid #3b2d6d; border-radius:16px; padding:12px;
  background:linear-gradient(180deg,#0f1233,#0d0f2b);
  box-shadow:0 10px 40px #000a;
}
.sidebar h3{font-family:var(--font-heading); margin:0 0 8px}
.tableWrap{max-height:520px; overflow:auto; border-radius:12px; border:1px solid #322b62}
table{width:100%; border-collapse:collapse; font-size:14px}
th,td{ text-align:left; padding:9px 10px; border-bottom:1px solid #2e2a58 }
th{ color:#e4dcff; background:linear-gradient(180deg,#1a1340,#140f2b); position:sticky; top:0; z-index:2; border-bottom-color:#3c3272 }
tbody tr:hover{ background:#161339 }
.me{ background:#1a1744 }
.rankIcon{ width:18px; height:18px; vertical-align:-3px; margin-right:6px }

/* Modal chung */
.modal-backdrop{position:fixed; inset:0; background:#0009; display:none; align-items:center; justify-content:center; z-index:1300}
.modal{width:min(540px,92vw); background:linear-gradient(180deg,#18133b,#100d2a); border:1px solid #4a3a82; border-radius:16px; padding:18px; box-shadow:0 22px 80px #000c, inset 0 0 0 1px #ffffff08}
.modal h2{margin:0 0 8px; font-family:var(--font-heading); font-weight:800; letter-spacing:.3px; text-shadow:0 2px 0 #0008}
.modal p{color:var(--muted); margin-top:0}
.modal input{width:100%; padding:11px 12px; border-radius:10px; border:1px solid #3f2f74; background:#110f29; color:#fff; outline:none; margin:8px 0 14px; box-shadow:inset 0 1px 0 #ffffff10}

/* ============ FX hiScore (95-100) ============ */
.fx-layer{ position:fixed; inset:0; display:none; place-items:center; pointer-events:none; z-index:1200 }
.fx-box{ display:flex; flex-direction:column; align-items:center; gap:18px; transform: translateZ(0); }
#fxIcon{
  width:264px; height:264px; object-fit:contain;
  filter: drop-shadow(0 0 24px rgba(255,255,255,.7)) drop-shadow(0 0 40px rgba(255,255,255,.35));
}
.fx-text{
  color:#fff !important;
  text-shadow:
    0 0 6px rgba(255,255,255,0.95),
    0 0 16px rgba(255,255,255,0.85),
    0 0 32px rgba(255,255,255,0.6);
  font-weight:900;
}
.fx-shake{ animation: fx-shake .45s ease-in-out 0s 3; }
@keyframes fx-shake{
  0%{transform: translate3d(0,0,0) rotate(0deg)}
  20%{transform: translate3d(-4px,2px,0) rotate(-1.2deg)}
  40%{transform: translate3d(3px,-3px,0) rotate(1.2deg)}
  60%{transform: translate3d(-3px,3px,0) rotate(-.8deg)}
  80%{transform: translate3d(2px,-2px,0) rotate(.8deg)}
  100%{transform: translate3d(0,0,0) rotate(0deg)}
}

/* Win layer (c√≥ c√¢u h·ªèi C√≥/Kh√¥ng) */
.win-layer{ position:fixed; inset:0; display:none; place-items:center; background:#0008; z-index:1400 }
.win-box{ display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center }
.win-gif{ width:min(420px,80vw); max-height:60vh; object-fit:contain; border-radius:12px; box-shadow:0 10px 40px #000a }
.win-text{ font-family:var(--font-heading); font-weight:900; font-size:clamp(18px,2.8vw,28px); text-shadow:0 0 16px #9b6bff,0 0 32px #fff; }

/* REST screen (ch·ªâ leaderboard) */
.rest-layer{ position:fixed; inset:0; display:none; z-index:1500; background:linear-gradient(180deg,#0c0f27ee,#090b1fef), var(--bg1) center/cover no-repeat; }
.rest-inner{ max-width:960px; margin:40px auto; padding:16px; }
.rest-top{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; }
.rest-title{ font-family:var(--font-heading); font-weight:900; font-size:clamp(18px,2.4vw,24px); color:#e9e6ff }
.rest-card{ border:1px solid #3b2d6d; border-radius:16px; padding:12px; background:linear-gradient(180deg,#0f1233,#0d0f2b); box-shadow:0 10px 40px #000a; }

/* Meadow screen sau khi ch·ªçn C√≥ */
.meadow-layer{
  position:fixed; inset:0;
  display:none;                 /* show b·∫±ng JS */
  place-items:center;
  z-index:1700;                 /* cao h∆°n m·ªçi overlay kh√°c */
  pointer-events:auto;          /* QUAN TR·ªåNG: nh·∫≠n click */
  background:
    linear-gradient(180deg,#0c0f27bb,#090b1fcc),
    var(--bg3) center/cover no-repeat;
}
.meadow-box{
  text-align:center;
  padding:24px 20px;
  border-radius:16px;
  background:linear-gradient(180deg,#18133b,#100d2a);
  border:1px solid #4a3a82;
  box-shadow:0 22px 80px #000c, inset 0 0 0 1px #ffffff08;
}
.meadow-box h2{
  margin:0 0 8px;
  font-family:var(--font-heading);
  font-weight:900;
  color:#fff;
  text-shadow:0 2px 0 #0008;
}
.meadow-box p{ color:#e9e6ff; opacity:.9; margin:0 0 14px; }

/* Welcome l·∫ßn ƒë·∫ßu (icon x5, responsive) */
.welcome-backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#0009; z-index:1600}
.welcome{width:min(560px,92vw); background:linear-gradient(180deg,#18133b,#100d2a); border:1px solid #4a3a82; border-radius:16px; padding:18px; text-align:center}
.welcome img{
  width: clamp(var(--welcome-icon-min), 42vw, var(--welcome-icon-max)); /* t·ªõi 420px ~ 5x */
  height: auto; object-fit:contain;
  filter:drop-shadow(0 0 16px #fff8) drop-shadow(0 0 28px #fff4);
  margin-bottom:12px;
}
@media (max-width:420px){
  .modal{padding:14px}
  .welcome{padding:16px}
}

/* Custom cursor cho v·∫Ω */
#cv.drawing {
  cursor: url('https://cdn-icons-png.flaticon.com/512/108/108005.png'), auto; /* Icon wand mi·ªÖn ph√≠, thay b·∫±ng URL c·ªßa b·∫°n n·∫øu c·∫ßn */
}

/* Canvas FX ƒë·∫∑t ch·ªìng l√™n canvas v·∫Ω */
#fxSpark {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none; /* kh√¥ng ch·∫∑n t∆∞∆°ng t√°c v·∫Ω */
}

/* End game display */
#endScore {
  display: none;
  text-align: center;
  color: #fff;
  font-size: 18px;
  margin-bottom: 8px;
  font-weight: 700;
}

#endMessage {
  display: none;
  color: var(--good);
  text-align: center;
  margin: 8px 0;
  font-weight: 700;
  font-size: 16px;
}
</style>
</head>
<body>

<div class="app">
  <h1>Circle of the Dark Forest</h1>

  <div class="grid">
    <!-- C·ªòT TR√ÅI -->
    <div>
      <p class="story">
        B·∫°n b·ªã m·∫Øc k·∫πt trong khu r·ª´ng ma qu·ª∑. C√°ch duy nh·∫•t ƒë·ªÉ tho√°t ra kh·ªèi khu r·ª´ng n√†y l√† s·ª≠ d·ª•ng ph√©p thu·∫≠t v√≤ng tr√≤n kh√¥ng gian.
		T√¥i bi·∫øt b·∫°n l√† ph√°p s∆∞ gi·ªèi! H√£y c·ªë g·∫Øng ƒë·∫°t 1500 ƒëi·ªÉm ƒë·ªÉ s·ªëng s√≥t r·ªùi kh·ªèi khu r·ª´ng n√†y nh√©! 
      </p>

      <!-- HUD -->
      <div class="hud">
        <div class="badge">Ph√°p s∆∞: <span id="playerName">‚Äî</span></div>
        <div class="badge">L∆∞·ª£t: <span id="roundNow">0</span>/10</div>
        <div class="badge">T·ªïng ƒëi·ªÉm: <span id="totalScore">0</span></div>
        <div class="badge" style="display:flex;gap:8px;align-items:center">
          <button id="bgmToggle" class="ghost">T·∫Øt nh·∫°c ‚è∏</button>
          <button id="bgmNext" class="ghost" title="B√†i ti·∫øp theo">Next ‚ñ∂</button>
          <input id="bgmVol" class="range" type="range" min="0" max="1" step="0.01" value="0.5" title="√Çm l∆∞·ª£ng"/>
        </div>
        <div class="badge" style="display:flex;gap:8px;align-items:center; display:none;">
			<button id="diffToggle" class="ghost" title="ƒê·ªïi ƒë·ªô kh√≥">ƒê·ªô kh√≥: Th∆∞·ªùng</button>
		</div>
      </div>

      <!-- Thanh ƒëi·ªÉm 2 h√†ng -->
      <div class="roundbar">
        <div id="rbTop" class="grid10 labels"></div>
        <div id="rbBot" class="grid10 values"></div>
      </div>

      <div class="stage">
        <div id="readyMask" class="ready-overlay">
          <div id="endScore">T·ªïng ƒëi·ªÉm: <span id="endTotalScore">0</span></div>
          <p id="endMessage"></p>
          <button id="readyBtn" class="pill">S·∫µn s√†ng ‚ñ∂</button>
        </div>
        <div id="centerAcc" class="center-acc">0%</div>
        <canvas id="cv" width="900" height="520"></canvas>
        <canvas id="fxSpark"></canvas>

        <!-- audio -->
        <audio id="greetBgm" loop preload="auto" playsinline></audio>
        <audio id="bgm" autoplay loop preload="auto" playsinline></audio>
        <audio id="sfx" preload="auto" playsinline></audio>
      </div>
    </div>

    <!-- C·ªòT PH·∫¢I -->
    <aside class="sidebar">
      <h3>üèÖ B·∫£ng x·∫øp h·∫°ng</h3>
      <div class="tableWrap">
        <table id="leaderTable">
          <thead><tr><th>#</th><th>T√™n</th><th>ƒêi·ªÉm</th><th>Th·ªùi gian</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </aside>
  </div>
</div>

<!-- Modal t√™n -->
<div class="modal-backdrop" id="nameModal">
  <div class="modal">
    <h2 id="modalTitle">Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
    <p>T√™n d√πng ƒë·ªÉ l∆∞u <b>t·ªïng ƒëi·ªÉm 10 l∆∞·ª£t</b> l√™n b·∫£ng x·∫øp h·∫°ng.</p>
    <input id="playerNameInput" type="text" placeholder="V√≠ d·ª•: Ph√°p s∆∞ An" maxlength="32"/>
    <div style="display:flex; gap:10px; justify-content:flex-end">
      <button id="stopPlay" class="ghost" style="display:none">D·ª´ng ch∆°i</button>
      <button id="saveName">B·∫Øt ƒë·∫ßu</button>
    </div>
  </div>
</div>

<!-- FX m·ªëc ƒëi·ªÉm -->
<div class="fx-layer" id="fxLayer">
  <div class="fx-box">
    <img id="fxIcon" alt="icon"/>
    <div id="fxText" class="fx-text">ƒêI·ªÇM CAO!</div>
  </div>
</div>

<!-- Win (kh√¥ng ƒë·∫øm ng∆∞·ª£c) -->
<div class="win-layer" id="winLayer">
  <div class="win-box">
    <img id="winGif" class="win-gif" alt="Victory"/>
    <div id="winMsg" class="win-text"></div>
    <div style="display:flex; gap:8px; margin-top:6px">
      <button id="winYes">C√≥</button>
      <button id="winNo" class="ghost">Kh√¥ng</button>
    </div>
  </div>
  <audio id="winAudio" playsinline></audio>
</div>

<!-- REST (ch·ªâ leaderboard) -->
<div class="rest-layer" id="restLayer">
  <div class="rest-inner">
    <div class="rest-top">
      <div class="rest-title">Ngh·ªâ ng∆°i ch√°n r·ªìi th√¨ ti·∫øp t·ª•c luy·ªán nh√©</div>
      <div style="display:flex;gap:8px">
        <button id="restPracticeBtn">Luy·ªán ‚ñ∂</button>
        <button id="restNextBtn" class="ghost" style="display:none">ThƒÉng c·∫•p</button>
        <button id="restResetBtn" class="ghost">Reset d·ªØ li·ªáu</button>
      </div>
    </div>
    <div class="rest-card">
      <div class="tableWrap">
        <table id="restLeaderTable">
          <thead><tr><th>#</th><th>T√™n</th><th>ƒêi·ªÉm</th><th>Th·ªùi gian</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- TH·∫¢O NGUY√äN / MEADOW -->
<div class="meadow-layer" id="meadowLayer">
  <div class="meadow-box">
    <h2 id="meadowTitle">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi th·∫£o nguy√™n</h2>
    <p id="meadowText">Ph·∫ßn n√†y ƒëang x√¢y d·ª±ng nhaa üåø</p>
    <button id="meadowBackBtn" class="ghost">Quay l·∫°i</button>
  </div>
</div>

<!-- Welcome (l·∫ßn ƒë·∫ßu) -->
<div class="welcome-backdrop" id="welcome">
  <div class="welcome">
    <img id="welcomeIcon" alt="icon"/>
    <h2 id="welcomeTitle">Welcome To Circle of the Dark Forest</h2>
    <p id="welcomeText">V·∫Ω v√≤ng tr√≤n c√†ng tr√≤n c√†ng t·ªët trong 10 l∆∞·ª£t. ƒê·∫°t 1500 ƒëi·ªÉm ƒë·ªÉ m·ªü th·ª≠ th√°ch ti·∫øp theo!</p>
    <div style="margin-top:12px">
      <button id="welcomeOk">B·∫Øt ƒë·∫ßu luy·ªán ‚ñ∂</button>
    </div>
  </div>
</div>

<!-- Box ‚Äúƒêang ph√°t tri·ªÉn‚Äù (ThƒÉng c·∫•p) -->
<div class="modal-backdrop" id="devModal">
  <div class="modal">
    <h2>ƒêang ph√°t tri·ªÉn</h2>
    <p>Ch·ªù ch√∫t nha‚Ä¶ T√≠nh nƒÉng n√†y s·∫Ω s·ªõm ra m·∫Øt.</p>
    <div style="display:flex; justify-content:flex-end; gap:10px">
      <button id="devClose">OK</button>
    </div>
  </div>
</div>

<script>
/* ==================== CONFIG ==================== */
const CONFIG = {
  assets: {
    bg1: 'https://puonglee269.github.io/Magic-Circle-Game/BG/60a64b90c2f11a5a9aa2df872f03e20d.jpg',
    bg2: 'https://puonglee269.github.io/Magic-Circle-Game/BG/60a64b90c2f11a5a9aa2df872f03e20d.jpg',
    bg3: 'https://puonglee269.github.io/Magic-Circle-Game/BG/c65da843bdbf6eb76173bae2a0bd5f50.jpg', // th√™m BG3
    bgm: [
      'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/File A 2-08_WormsTeam - The Fairy Tale (Full).mp3',  // Thay URL b√†i 1
      'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Dark Forest 2.mp3',  // Thay URL b√†i 2
      'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Magical Fairy Tale.mp3',  // Thay URL b√†i 3
      'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/The Crystal Cave_01.mp3',  // Thay URL b√†i 4
      'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Wonderland.mp3'   // Thay URL b√†i 5
    ],
  },
  fonts: {
    heading: "'Texturina', ui-serif, Georgia, serif",
    body: "'Texturina', ui-serif, Georgia, serif"
  },
  difficulty: {
    mode: 'Thuong',                // 'Thuong' | 'De'
    easyBoost: { scale: 1.06, add: 4, snapAt: 98 }
  },
  greeting: {
    icon: 'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/ChatGPT%20Image%2017_37_09%2020%20thg%2010%2C%202025.png',
    sound: 'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Dark%20Forest.mp3',
    title: 'Ch√†o m·ª´ng Ph√°p s∆∞!',
    text: 'B·∫°n ƒëang ·ªü trong khu r·ª´ng nguy hi·ªÉm. H√£y v·∫Ω v√≤ng tr√≤n ma thu·∫≠t trong 10 l∆∞·ª£t v√† ƒë·∫°t 1500 ƒëi·ªÉm ƒë·ªÉ m·ªü c·ªïng kh√¥ng gian!'
  },
  hiEffects: {
    95:{ icon:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/ChatGPT%20Image%2017_36_49%2020%20thg%2010%2C%202025.png', sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Magic%20Game%20Absurb%20Pick%20Up.wav', text:'Gh√™ nha!', style:{font:"'Texturina', serif",size:56,color:'#ffffff'} },
    96:{ icon:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/ChatGPT%20Image%2017_37_13%2020%20thg%2010%2C%202025.png', sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Magic%20Game%20Absurb%20Pick%20Up%203.wav', text:'Kh√¥ng th·ªÉ tin n·ªïi', style:{font:"'Texturina', serif",size:58,color:'#ffffff'} },
    97:{ icon:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/ChatGPT%20Image%2017_37_21%2020%20thg%2010%2C%202025.png', sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Magic%20Game%20Absurb%20Pick%20Up%202.wav', text:'B·∫°n l√† si√™u nh√¢n √†??', style:{font:"'Texturina', serif",size:60,color:'#ffffff'} },
    98:{ icon:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/ChatGPT%20Image%2017_37_17%2020%20thg%2010%2C%202025.png', sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Magic.mp3', text:'B·∫°n l√† th·∫ßn th√†nh ph∆∞∆°ng n√†o?', style:{font:"'Texturina', serif",size:64,color:'#ffffff'} },
    99:{ icon:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/ChatGPT%20Image%2017_43_53%2020%20thg%2010%2C%202025.png', sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Ancient%20Game%20Epic%20Magic%20Hit%201.wav', text:'B·∫°n ch√≠nh l√† huy·ªÅn tho·∫°i to√†n v≈© tr·ª•', style:{font:"'Texturina', serif",size:70,color:'#ffffff'} },
    100:{ icon:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/c433f175-f7f4-4d99-b6a7-ea19fdba1549.png', sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/Ancient%20Game%20Epic%20Magic%20Hit%201.wav', text:'Con l·∫°y ch√∫a t·ªÉ ph√©p thu·∫≠t to√†n nƒÉng!', style:{font:"'Texturina', serif",size:80,color:'#ffffff'} },
  },
  rankIcons:{
    1:'https://puonglee269.github.io/Magic-Circle-Game/assets/icon/ChatGPT%20Image%2018_53_13%2020%20thg%2010%2C%202025.png',
    2:'https://puonglee269.github.io/Magic-Circle-Game/assets/icon/ChatGPT%20Image%2018_53_20%2020%20thg%2010%2C%202025.png',
    3:'https://puonglee269.github.io/Magic-Circle-Game/assets/icon/ChatGPT%20Image%2018_53_34%2020%20thg%2010%2C%202025.png'
  },
  win:{
    threshold:1500,
    gif:'https://puonglee269.github.io/Magic-Circle-Game/assets/Emotion/owl_fireworks_loop.gif',
    sound:'https://puonglee269.github.io/Magic-Circle-Game/assets/SFX/huge%20win.wav'
  }
};

/* Fallback ƒë·∫£m b·∫£o difficulty t·ªìn t·∫°i */
(function ensureDifficulty(){
  if(!CONFIG.difficulty || typeof CONFIG.difficulty!=='object'){ CONFIG.difficulty={}; }
  if(!('mode' in CONFIG.difficulty)){ CONFIG.difficulty.mode='Thuong'; }
  if(!CONFIG.difficulty.easyBoost || typeof CONFIG.difficulty.easyBoost!=='object'){
    CONFIG.difficulty.easyBoost={ scale:1.06, add:4, snapAt:98 };
  }
})();

/* √Åp bi·∫øn CSS + audio src */
document.documentElement.style.setProperty('--bg1', `url('${CONFIG.assets.bg1}')`);
document.documentElement.style.setProperty('--bg2', `url('${CONFIG.assets.bg2}')`);
if (CONFIG.assets && CONFIG.assets.bg3) {
  document.documentElement.style.setProperty('--bg3', `url('${CONFIG.assets.bg3}')`);
}
document.documentElement.style.setProperty('--font-heading', CONFIG.fonts.heading);
document.documentElement.style.setProperty('--font-body', CONFIG.fonts.body);

/* ==================== Helpers m√†u & n√©t ==================== */
const clamp=(x,a,b)=>Math.min(Math.max(x,a),b);
const hexToRgb=h=>[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];
const rgbToHex=(r,g,b)=>'#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
const lerp=(a,b,t)=>a+(b-a)*t;
const lerpColor=(c1,c2,t)=>rgbToHex(Math.round(lerp(c1[0],c2[0],t)),Math.round(lerp(c1[1],c2[1],t)),Math.round(lerp(c1[2],c2[2],t)));
const RED=hexToRgb('#ff6a8e'), YELLOW=hexToRgb('#ffd76a'), GREEN=hexToRgb('#2be9d4'), NEONPUR=hexToRgb('#b96bff');
function brushStyleFromAcc(acc){
  const a=clamp(acc,0,100);
  if(a<80) return {color:rgbToHex(...RED),blur:0};
  if(a<90){const t=(a-80)/10; return {color:lerpColor(RED,YELLOW,t),blur:0};}
  if(a<95){const t=(a-90)/5; return {color:lerpColor(YELLOW,GREEN,t),blur:12+t*12};}
  {const t=(a-95)/5; return {color:lerpColor(GREEN,NEONPUR,t),blur:22+t*28};}
}

/* N√©t m∆∞·ª£t */
function resample(pts, step=1.8){
  const s=Math.max(0.5,step); if(pts.length<2) return pts.slice();
  const out=[{...pts[0]}]; let acc=0; let a=out[0];
  for(let i=1;i<pts.length;i++){
    const b=pts[i]; let dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy);
    if(d===0){ a=b; continue; }
    while(acc+d>=s){
      const t=(s-acc)/d; out.push({x:a.x+dx*t,y:a.y+dy*t});
      a=out[out.length-1]; dx=b.x-a.x; dy=b.y-a.y; d=Math.hypot(dx,dy); acc=0;
    }
    acc+=d; a=b;
  }
  if(out.length<pts.length) out.push({...pts[pts.length-1]});
  if(out.length>4000) out.splice(0,out.length-4000);
  return out;
}
function catmullRomToBezier(pts,tension=0.7){
  const n=pts.length; if(n<2) return null; const segs=[];
  for(let i=0;i<n-1;i++){
    const p0=pts[i-1]||pts[i], p1=pts[i], p2=pts[i+1]||pts[i], p3=pts[i+2]||p2;
    const c1x=p1.x+(p2.x-p0.x)*(tension/6), c1y=p1.y+(p2.y-p0.y)*(tension/6);
    const c2x=p2.x-(p3.x-p1.x)*(tension/6), c2y=p2.y-(p3.y-p1.y)*(tension/6);
    segs.push({c1x,c1y,c2x,c2y,x:p2.x,y:p2.y});
  }
  return {start:pts[0],segs};
}
function drawSmoothStroke(ctx, pts, color, coreWidth=3, glow=20){
  if(pts.length<2) return;
  const uniform=resample(pts,1.8), path=catmullRomToBezier(uniform,0.7); if(!path) return;
  ctx.beginPath(); ctx.moveTo(path.start.x,path.start.y);
  for(const s of path.segs) ctx.bezierCurveTo(s.c1x,s.c1y,s.c2x,s.c2y,s.x,s.y);
  ctx.lineJoin='round'; ctx.lineCap='round';
  const prev=ctx.globalCompositeOperation;
  ctx.globalCompositeOperation='lighter'; ctx.strokeStyle=color; ctx.shadowColor=color; ctx.shadowBlur=Math.min(32,glow);
  ctx.lineWidth=coreWidth+ctx.shadowBlur*0.35; ctx.globalAlpha=0.75; ctx.stroke();
  ctx.shadowBlur=0; ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';
  ctx.lineWidth=coreWidth; ctx.strokeStyle=color; ctx.stroke();
  ctx.globalAlpha=0.22; ctx.lineWidth=Math.max(1,coreWidth*0.45); ctx.strokeStyle='#fff'; ctx.stroke();
  ctx.globalAlpha=1; ctx.globalCompositeOperation=prev;
}

/* Fit circle + ƒëi·ªÉm */
function solve3(A,b){
  const det=m=>m[0][0]*(m[1][1]*m[2][2]-m[1][2]*m[2][1]) - m[0][1]*(m[1][0]*m[2][2]-m[1][2]*m[2][0]) + m[0][2]*(m[1][0]*m[2][1]-m[1][1]*m[2][0]);
  const D=det(A); if(Math.abs(D)<1e-9) return null;
  const rep=col=>A.map((r,i)=>r.map((v,j)=> j===col? b[i] : v));
  const Dx=det(rep(0)), Dy=det(rep(1)), Dz=det(rep(2)); return [Dx/D,Dy/D,Dz/D];
}
function fitCircleKasa(pts){
  const n=pts.length; if(n<6) return null;
  let Sx=0,Sy=0,Sxx=0,Syy=0,Sxy=0,Sz=0,Sxz=0,Syz=0;
  for(const p of pts){ const x=p.x,y=p.y,z=x*x+y*y; Sx+=x;Sy+=y;Sxx+=x*x;Syy+=y*y;Sxy+=x*y;Sz+=z;Sxz+=x*z;Syz+=y*z; }
  const A=[[Sxx,Sxy,Sx],[Sxy,Syy,Sy],[Sx,Sy,n]], bb=[Sxz,Syz,Sz];
  const sol=solve3(A,bb); if(!sol) return null; const [A1,B1,C1]=sol; const a=A1/2,b0=B1/2;
  const R2=a*a+b0*b0+C1; if(R2<=0) return null; return {cx:a,cy:b0,r:Math.sqrt(R2)};
}
function angularCoverage(pts,cx,cy){
  const angs=pts.map(p=>Math.atan2(p.y-cy,p.x-cx)).sort((a,b)=>a-b); if(angs.length<2) return 0;
  let maxGap=0; for(let i=0;i<angs.length-1;i++) maxGap=Math.max(maxGap,angs[i+1]-angs[i]);
  maxGap=Math.max(maxGap,(Math.PI*2-(angs[angs.length-1]-angs[0]))); return Math.min(Math.max(1-maxGap/(Math.PI*2),0),1);
}
function accuracyScore(pts,circle){
  const {cx,cy,r}=circle; let s=0; for(const p of pts){ const d=Math.hypot(p.x-cx,p.y-cy); const e=d-r; s+=e*e; }
  const rms=Math.sqrt(s/pts.length); const shape=Math.min(Math.max(1-(rms/(0.25*r||1)),0),1); const coverage=angularCoverage(pts,cx,cy);
  const acc=(0.7*shape+0.3*coverage)*100; return {acc:Math.round(acc),rms,coverage,shape};
}

/* ====== Difficulty helpers ====== */
const LS_DIFF='circle_diff_mode';
function getDiffMode(){ return localStorage.getItem(LS_DIFF) || (CONFIG.difficulty && CONFIG.difficulty.mode) || 'Thuong'; }
function setDiffMode(m){
  CONFIG.difficulty.mode = m; localStorage.setItem(LS_DIFF,m);
  diffToggle.textContent = 'ƒê·ªô kh√≥: ' + (m==='De'?'D·ªÖ':'Th∆∞·ªùng');
}
function applyDifficultyBoost(rawAcc){
  const mode=getDiffMode();
  if(mode!=='De') return rawAcc;
  var eb = (CONFIG.difficulty && CONFIG.difficulty.easyBoost) || { scale:1, add:0, snapAt:101 };
  var a = Math.round(rawAcc*eb.scale + eb.add);
  if(a>=eb.snapAt) a=100;
  return Math.min(100, Math.max(0, a));
}

/* ==== DOM refs ==== */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
const fxCv = document.getElementById('fxSpark');
const fxCtx = fxCv.getContext('2d');
const centerAcc=document.getElementById('centerAcc');
const roundNowEl=document.getElementById('roundNow'), totalScoreEl=document.getElementById('totalScore');
const readyBtn=document.getElementById('readyBtn'), readyMask=document.getElementById('readyMask');
const endScore = document.getElementById('endScore');
const endMessage = document.getElementById('endMessage');
const endTotalScore = document.getElementById('endTotalScore');
const playerNameEl=document.getElementById('playerName');
const nameModal=document.getElementById('nameModal'), nameInput=document.getElementById('playerNameInput'), saveNameBtn=document.getElementById('saveName'), modalTitle=document.getElementById('modalTitle'), stopPlayBtn=document.getElementById('stopPlay');
const leaderTable=document.querySelector('#leaderTable tbody');
const restLayer=document.getElementById('restLayer'), restPracticeBtn=document.getElementById('restPracticeBtn'), restNextBtn=document.getElementById('restNextBtn'), restResetBtn=document.getElementById('restResetBtn'), restLeaderBody=document.querySelector('#restLeaderTable tbody');
const greetBgm=document.getElementById('greetBgm'), bgmEl=document.getElementById('bgm'), sfxEl=document.getElementById('sfx');
const bgmToggle=document.getElementById('bgmToggle'), bgmVol=document.getElementById('bgmVol'), bgmNext=document.getElementById('bgmNext');
const diffToggle=document.getElementById('diffToggle');
const winLayer=document.getElementById('winLayer'), winGif=document.getElementById('winGif'), winAudio=document.getElementById('winAudio'), winMsg=document.getElementById('winMsg'), winYes=document.getElementById('winYes'), winNo=document.getElementById('winNo');
const welcome=document.getElementById('welcome'), welcomeIcon=document.getElementById('welcomeIcon'), welcomeTitle=document.getElementById('welcomeTitle'), welcomeText=document.getElementById('welcomeText'), welcomeOk=document.getElementById('welcomeOk');
const meadowLayer = document.getElementById('meadowLayer');
const meadowBackBtn = document.getElementById('meadowBackBtn');
const devModal=document.getElementById('devModal'), devClose=document.getElementById('devClose');

let pts=[], livePreview=false, needsRedraw=false;
let roundNow=0, totalScore=0, gameActive=false;
let won=false;
let isEndGame = false;
const perRoundScores = new Array(10).fill(null);
const perRoundAcc = new Array(10).fill(null);

// ===== Wand & Sparks =====
let wandImg = new Image();
wandImg.src = 'https://puonglee269.github.io/Magic-Circle-Game/assets/wand/wand.png'; // PNG trong su·ªët, c√°n + ƒë·∫ßu ph√°t s√°ng
let wandReady = false;
wandImg.onload = ()=> wandReady = true;

let wandShow = false;          // hi·ªán/·∫©n ƒë≈©a
let wandX = 0, wandY = 0;      // v·ªã tr√≠ hi·ªán t·∫°i
let wandVX = 0, wandVY = 0;    // v·∫≠n t·ªëc ƒë·ªÉ xoay
let lastDrawPos = null;        // d√πng t√≠nh t·ªëc ƒë·ªô & tia l·ª≠a

// H·ªá th·ªëng h·∫°t
const sparks = [];             // m·∫£ng particle
const MAX_SPARKS = 400;

// ===== BGM Playlist =====
let bgmIndex = 0;
let bgmTracks = CONFIG.assets.bgm;

/* ===== Scale canvas (Safari safe) ===== */
function scaleCanvas(){
  const dpr=window.devicePixelRatio||1, cssW=cv.clientWidth, cssH=cv.clientHeight; if(!cssW||!cssH) return;
  cv.width=Math.round(cssW*dpr); cv.height=Math.round(cssH*dpr); ctx.setTransform(dpr,0,0,dpr,0,0);
  fxCv.width = Math.round(cssW * dpr);
  fxCv.height = Math.round(cssH * dpr);
  fxCtx.setTransform(dpr,0,0,dpr,0,0);
  needsRedraw=true;
}
window.addEventListener('resize', scaleCanvas);
window.addEventListener('load', scaleCanvas);
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(scaleCanvas,0); });

/* ===== V·∫Ω ===== */
function clear(){ ctx.clearRect(0,0,cv.width,cv.height); }
function drawStroke(liveAcc=null){
  if(pts.length<2) return;
  const style=(liveAcc==null)?{color:'#e6e1ff',blur:0}:brushStyleFromAcc(liveAcc);
  const core=2.6 + (liveAcc ? (liveAcc-75)*0.035 : 0), glow=(liveAcc?style.blur:10)+6;
  drawSmoothStroke(ctx, pts, style.color, core, glow);
}
function computeLiveAcc(){
  if(pts.length<6) return null;
  const circle=fitCircleKasa(pts);
  if(!circle) return null;
  let a = accuracyScore(pts,circle).acc;
  a = applyDifficultyBoost(a);
  return a;
}
function redraw(live=false){
  clear();
  let liveAcc=null;
  if(live){ liveAcc = computeLiveAcc(); }
  drawStroke(liveAcc);
  centerAcc.style.opacity=(live && liveAcc!=null)?1:0;
  if(live && liveAcc!=null) centerAcc.textContent=liveAcc+'%';
}

/* Emitter tia l·ª≠a */
function emitSparks(x, y, speed){
  // l∆∞·ª£ng h·∫°t theo t·ªëc ƒë·ªô tay (gi·ªõi h·∫°n)
  const count = Math.min(8, Math.floor(1 + speed * 0.25));
  for(let i=0;i<count;i++){
    if(sparks.length > MAX_SPARKS){ sparks.shift(); }
    // g√≥c ng·∫´u nhi√™n quanh h∆∞·ªõng di chuy·ªÉn
    const baseAng = Math.atan2(wandVY, wandVX);
    const ang = baseAng + (Math.random()-0.5) * 0.8; // ¬±0.4 rad
    const spd = Math.min(10, 1.5 + speed * (0.25 + Math.random()*0.15)); // t·ªëc ƒë·ªô h·∫°t
    sparks.push({
      x, y,
      vx: Math.cos(ang) * spd,
      vy: Math.sin(ang) * spd - 0.6,    // h∆°i v·ªçt l√™n
      life: 1.0,                        // 1 ‚Üí 0
      decay: 0.02 + Math.random()*0.03, // s·ªëng ng·∫Øn nh∆∞ ph√°o
      size: 2 + Math.random()*2.5
    });
  }
}

function renderSparks(){
  // n·ªÅn trong su·ªët + v·∫Ω h·∫°t v·ªõi "lighter" ƒë·ªÉ ch√°y s√°ng
  fxCtx.clearRect(0,0,fxCv.width,fxCv.height);
  fxCtx.save();
  fxCtx.globalCompositeOperation = 'lighter';

  for(let i=sparks.length-1; i>=0; i--){
    const p = sparks[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.12;     // tr·ªçng l·ª±c nh·∫π
    p.life -= p.decay;

    if(p.life <= 0){
      sparks.splice(i,1);
      continue;
    }

    const a = Math.max(0, p.life);
    const r = p.size;
    const g = fxCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, r*3);
    // l√µi tr·∫Øng ‚Üí v√†ng ‚Üí h·ªìng t√≠m
    g.addColorStop(0.00, `rgba(255,255,255,${0.9*a})`);
    g.addColorStop(0.25, `rgba(255,230,120,${0.7*a})`);
    g.addColorStop(1.00, `rgba(190,110,255,0)`);
    fxCtx.fillStyle = g;
    fxCtx.beginPath();
    fxCtx.arc(p.x, p.y, r*3, 0, Math.PI*2);
    fxCtx.fill();
  }
  fxCtx.restore();
}

function renderWand(){
  if(!wandShow || !wandReady) return;
  // g√≥c quay theo v·∫≠n t·ªëc (m·ªÅm m∆∞·ª£t)
  const angle = Math.atan2(wandVY, wandVX);
  const scale = 0.8; // c√≥ th·ªÉ ch·ªânh k√≠ch th∆∞·ªõc ƒë≈©a
  const w = 96 * scale, h = 96 * scale; // 1 PNG vu√¥ng, ƒë·∫ßu ƒë≈©a ·ªü g√≥c ph·∫£i

  // V·∫Ω glow nh·ªè ·ªü ƒë·∫ßu ƒë≈©a
  fxCtx.save();
  // ƒë·∫ßu ƒë≈©a ·ªü v·ªã tr√≠ wandX, wandY ‚Äì d·ªùi ·∫£nh sao cho ƒë·∫ßu ƒë≈©a tr√πng ƒë·∫ßu n√©t
  fxCtx.translate(wandX, wandY);
  fxCtx.rotate(angle);
  fxCtx.translate(-w*0.1, -h*0.5); // ch·ªânh g·ªëc neo (t√πy PNG)
  fxCtx.drawImage(wandImg, 0, 0, w, h);

  // qu·∫ßng s√°ng ƒë·∫ßu ƒë≈©a (d√πng th√™m radial gradient)
  fxCtx.globalCompositeOperation = 'lighter';
  const glow = fxCtx.createRadialGradient(w*0.95, h*0.5, 0, w*0.95, h*0.5, 26);
  glow.addColorStop(0, 'rgba(255,255,255,0.85)');
  glow.addColorStop(0.4, 'rgba(200,140,255,0.55)');
  glow.addColorStop(1, 'rgba(200,140,255,0)');
  fxCtx.fillStyle = glow;
  fxCtx.beginPath();
  fxCtx.arc(w*0.95, h*0.5, 26, 0, Math.PI*2);
  fxCtx.fill();

  fxCtx.restore();
}

function loop(){ 
  if(needsRedraw){ redraw(livePreview); needsRedraw=false; }
  // Render FX m·ªói frame
  renderSparks();
  renderWand();
  requestAnimationFrame(loop); 
} requestAnimationFrame(loop);

/* ===== WebAudio: sizzle + BGM ===== */
let audioCtx=null, sizzleGain=null, sizzleSrc=null;
function ensureAC(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }

function startSizzle(){
  const ac=ensureAC();
  const buffer=ac.createBuffer(1, ac.sampleRate*2, ac.sampleRate);
  const data=buffer.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
  const src=ac.createBufferSource(); src.buffer=buffer; src.loop=true;
  const hp=ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000;
  const bp=ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=8000; bp.Q.value=0.7;
  const g=ac.createGain(); g.gain.value=0.0001;
  src.connect(hp); hp.connect(bp); bp.connect(g); g.connect(ac.destination);
  src.start();
  sizzleGain=g; sizzleSrc=src;
}
function stopSizzle(){
  try{ if(sizzleGain){ sizzleGain.gain.exponentialRampToValueAtTime(0.0001, ensureAC().currentTime+0.05); } }catch(_){}
  try{ if(sizzleSrc){ sizzleSrc.stop(ensureAC().currentTime+0.06); } }catch(_){}
  sizzleGain=null; sizzleSrc=null;
}

/* ===== Greeting BGM (m·ªü ƒë·∫ßu) + Game BGM ===== */
greetBgm.src = CONFIG.greeting.sound; greetBgm.crossOrigin = "anonymous";

async function tryPlay(el){
  try{ await el.play(); }catch(e){
    // iOS ch·∫∑n: b·∫≠t khi c√≥ t∆∞∆°ng t√°c ƒë·∫ßu ti√™n
    const unlock = async ()=>{
      try{ if(audioCtx && audioCtx.state!=='running'){ await audioCtx.resume(); } await el.play(); }catch(_){}
      window.removeEventListener('touchstart',unlock);
      window.removeEventListener('pointerdown',unlock);
      window.removeEventListener('keydown',unlock);
    };
    window.addEventListener('touchstart',unlock,{once:true,passive:true});
    window.addEventListener('pointerdown',unlock,{once:true});
    window.addEventListener('keydown',unlock,{once:true});
  }
}

function startGreetingBgm(){
  greetBgm.loop = true;
  tryPlay(greetBgm);
}
function stopGreetingBgm(){
  try{ greetBgm.pause(); }catch(_){}
}
function startGameBgm(){
  loadBgmTrack(bgmIndex);
}
function loadBgmTrack(index) {
  bgmIndex = index % bgmTracks.length;
  bgmEl.src = bgmTracks[bgmIndex];
  bgmEl.crossOrigin = "anonymous";
  if (!bgmEl.paused) {
    bgmEl.play().catch(() => {});
  }
}
function setBgmUi(){ bgmToggle.textContent=(bgmEl.paused?'B·∫≠t nh·∫°c ‚ô™':'T·∫Øt nh·∫°c ‚è∏'); }
function initBgm(){
  const v=parseFloat(localStorage.getItem('circle_bgm_vol')||'0.5');
  bgmEl.volume=isNaN(v)?0.5:Math.max(0,Math.min(1,v));
  bgmVol.value=String(bgmEl.volume);
  // KH√îNG t·ª± play bgmEl ·ªü ƒë·∫ßu ‚Äî ch·ªâ greeting ph√°t tr∆∞·ªõc
  setBgmUi();
  // Load track ƒë·∫ßu ti√™n
  loadBgmTrack(0);
}
bgmToggle.addEventListener('click', async ()=>{
  if(bgmEl.paused){ try{ await bgmEl.play(); }catch(_){ } } else { bgmEl.pause(); }
  setBgmUi();
});
bgmNext.addEventListener('click', () => {
  const nextIndex = bgmIndex + 1;
  loadBgmTrack(nextIndex);
});
bgmVol.addEventListener('input', ()=>{
  const v=parseFloat(bgmVol.value||'0.5');
  bgmEl.volume=Math.max(0,Math.min(1,v));
  localStorage.setItem('circle_bgm_vol', String(bgmEl.volume));
});

/* ===== Input ===== */
function getPosFromXY(x,y){ const r=cv.getBoundingClientRect(); return {x:x-r.left, y:y-r.top}; }
function beginFromXY(x,y){
  if(!gameActive) return;
  if(pts.length>0) return;
  pts=[getPosFromXY(x,y)];
  livePreview=true; needsRedraw=true;
  cv.classList.add('drawing');
  startSizzle();
  wandShow = true;
  lastDrawPos = { x: pts[0].x, y: pts[0].y };
  wandX = pts[0].x; 
  wandY = pts[0].y;
  wandVX = 1; 
  wandVY = 0;
}
function moveFromXY(x,y){
  if(!livePreview) return;
  let p=getPosFromXY(x,y);
  if(pts.length){
    const q=pts[pts.length-1];
    const nx=q.x*0.8+p.x*0.2, ny=q.y*0.8+p.y*0.2;
    p={x:nx,y:ny};
    const speed=Math.hypot(nx-q.x,ny-q.y);
    if(sizzleGain){ const v=Math.min(0.35, speed*0.02); sizzleGain.gain.linearRampToValueAtTime(v, ensureAC().currentTime+0.02); }
  }
  pts.push(p); needsRedraw=true;
  // c·∫≠p nh·∫≠t ƒë≈©a + tia l·ª≠a
  if (lastDrawPos){
    const dx = p.x - lastDrawPos.x;
    const dy = p.y - lastDrawPos.y;
    const speed = Math.hypot(dx, dy);

    // n·ªôi suy v·ªã tr√≠ ƒë≈©a cho m∆∞·ª£t (easing)
    wandX = lastDrawPos.x + dx;
    wandY = lastDrawPos.y + dy;

    // low-pass v·∫≠n t·ªëc ƒë·ªÉ g√≥c quay m∆∞·ª£t
    wandVX = wandVX * 0.7 + dx * 0.3;
    wandVY = wandVY * 0.7 + dy * 0.3;

    // ph√°t tia l·ª≠a theo t·ªëc ƒë·ªô tay
    emitSparks(wandX, wandY, speed);
    lastDrawPos = { x: p.x, y: p.y };
  } else {
    lastDrawPos = { x: p.x, y: p.y };
  }
}
function endGeneric(){
  if(!livePreview) return;
  livePreview=false; needsRedraw=true; 
  cv.classList.remove('drawing');
  stopSizzle(); 
  wandShow = false;
  lastDrawPos = null;
  // v·∫´n ƒë·ªÉ sparks t·ª± t·∫Øt theo life; n·∫øu mu·ªën t·∫Øt ngay:
  // sparks.length = 0;
  computeAndFinish();
}

/* Pointer + Touch */
cv.addEventListener('pointerdown', e=>{ e.preventDefault(); beginFromXY(e.clientX,e.clientY); }, {passive:false});
cv.addEventListener('pointermove',  e=>{ if(!livePreview) return; e.preventDefault(); moveFromXY(e.clientX,e.clientY); }, {passive:false});
window.addEventListener('pointerup', e=>{ if(!livePreview) return; e.preventDefault(); endGeneric(); }, {passive:false});
cv.addEventListener('touchstart', e=>{ if(!e.touches.length) return; e.preventDefault(); const t=e.touches[0]; beginFromXY(t.clientX,t.clientY); }, {passive:false});
cv.addEventListener('touchmove',  e=>{ if(!e.touches.length) return; e.preventDefault(); const t=e.touches[0]; moveFromXY(t.clientX,t.clientY); }, {passive:false});
cv.addEventListener('touchend',   e=>{ e.preventDefault(); endGeneric(); }, {passive:false});

/* ===== ƒêi·ªÉm & m·ªëc ===== */
function multiplierFromAcc(a){
  if(a>=100) return 5;
  if(a>=99)  return 4;
  if(a>=98)  return 3;
  if(a>=97)  return 2;
  if(a>=96)  return 1.8;
  if(a>=90)  return 1.5;   // 90..95
  if(a>=80)  return 1.2;   // 80..89
  return 1;                // <80
}
function bucketForEffects(a){
  if(a>=100) return 100; if(a>=99) return 99; if(a>=98) return 98; if(a>=97) return 97; if(a>=96) return 96; if(a>=95) return 95; return null;
}

/* ===== FX 95‚Äì100% ===== */
const fxLayer=document.getElementById('fxLayer'), fxIcon=document.getElementById('fxIcon'), fxText=document.getElementById('fxText');
function triggerHiEffect(bucket, accVal){
  var cfg = CONFIG.hiEffects[bucket];
  if(!cfg) return;
  fxIcon.src = cfg.icon || '';
  fxText.textContent = (cfg.text || 'ƒêI·ªÇM CAO!');

  var sizePx = (cfg.style && cfg.style.size) ? cfg.style.size : 56;
  fxText.style.fontFamily = (cfg.style && cfg.style.font) ? cfg.style.font : "'Texturina', serif";
  fxText.style.fontSize = sizePx + 'px';
  fxText.style.color = '#fff';

  fxIcon.classList.remove('fx-shake'); fxText.classList.remove('fx-shake');
  void fxIcon.offsetWidth;
  fxIcon.classList.add('fx-shake'); fxText.classList.add('fx-shake');

  fxLayer.style.display='grid';
  if(cfg.sound){ sfxEl.src = cfg.sound; try{ sfxEl.currentTime=0; sfxEl.play(); }catch(_){} }

  setTimeout(()=>{ fxLayer.style.display='none'; fxIcon.classList.remove('fx-shake'); fxText.classList.remove('fx-shake'); }, 1500);
}

/* ===== T√≠nh ƒëi·ªÉm l∆∞·ª£t ===== */
function computeAndFinish(){
  const circle=fitCircleKasa(pts);
  let acc=0;
  if(circle){
    acc = accuracyScore(pts,circle).acc;
    acc = applyDifficultyBoost(acc);
    drawSmoothStroke(ctx, pts, brushStyleFromAcc(acc).color, 3, 26);
  }
  const mul=multiplierFromAcc(acc);
  const roundScore=Math.round(acc*mul);
  perRoundScores[roundNow-1]=roundScore;
  perRoundAcc[roundNow-1]=acc;
  totalScore += roundScore; totalScoreEl.textContent=String(totalScore);
  updateRoundBar();

  const b=bucketForEffects(acc); if(b) triggerHiEffect(b, acc);
  lockDraw();

  if(!won && totalScore>CONFIG.win.threshold){ won=true; triggerWinOnce(); return; }
  if(roundNow<10){ setTimeout(nextRound, 350); } else { setTimeout(finishGame, 350); }
}

/* ===== Win only once ===== */
const LS_WIN_ONCE='circle_win_once';
function triggerWinOnce(){
  if(localStorage.getItem(LS_WIN_ONCE)==='1'){ return; }
  localStorage.setItem(LS_WIN_ONCE,'1');
  showWin();
}
function showWin(){
  // N·ªôi dung th·∫Øng + h·ªèi C√≥/Kh√¥ng
  winGif.src=CONFIG.win.gif;
  const name = getPlayerName() || 'Ph√°p s∆∞';
  winMsg.textContent = `Ch√∫c m·ª´ng ${name} ƒë√£ ƒë·ªß nƒÉng l∆∞·ª£ng m·ªü c√°nh c√°nh c·ªïng ma thu·∫≠t, b·∫°n c√≥ mu·ªën r·ªùi kh·ªèi ƒë√¢y kh√¥ng?`;
  winLayer.style.display='grid';
  winAudio.src=CONFIG.win.sound;
  try{ winAudio.play(); }catch(_){}
}

// Hi·ªán th·∫£o nguy√™n
function showMeadow() {
  // ƒë·∫£m b·∫£o c√°c overlay kh√°c t·∫Øt ƒëi
  winLayer.style.display = 'none';
  fxLayer.style.display = 'none';

  // t·∫°m d·ª´ng nh·∫°c n·ªÅn game (n·∫øu mu·ªën gi·ªØ y√™n tƒ©nh)
  try { bgmEl.pause(); } catch (_) {}

  // set background body ƒë·ªÉ match
  document.body.style.background =
    `linear-gradient(180deg,#0c0f27bb,#090b1fcc), var(--bg3) center/cover fixed no-repeat`;

  meadowLayer.style.display = 'grid';
}

// ·∫®n th·∫£o nguy√™n v√† quay l·∫°i REST
function hideMeadow() {
  meadowLayer.style.display = 'none';
  // reset background body v·ªÅ g·ªëc
  document.body.style.background =
    `linear-gradient(180deg,#0a0e18aa,#0a0e18aa), var(--bg1) center/cover fixed no-repeat`;
  // resume bgm n·∫øu c·∫ßn
  try { if (!bgmEl.paused) bgmEl.play(); } catch (_) {}
  showRestScreen(true);
}
winYes.addEventListener('click', showMeadow);
meadowBackBtn.addEventListener('click', hideMeadow);
winNo.addEventListener('click', ()=>{
  // ƒê√≥ng win ‚Üí ti·∫øp t·ª•c
  winLayer.style.display='none';
});

/* ===== Flow: S·∫µn s√†ng / 10 l∆∞·ª£t ===== */
function lockDraw(){ gameActive=false; readyMask.style.display='grid'; pts=[]; needsRedraw=true; centerAcc.style.opacity=0; }
function unlockDraw(){ gameActive=true; readyMask.style.display='none'; pts=[]; needsRedraw=true; centerAcc.style.opacity=0; }

readyBtn.addEventListener('click', () => {
  if (isEndGame) {
    showNameModal(true, true);
  } else {
    unlockDraw();
  }
});

function startGame(){
  // Chuy·ªÉn nh·∫°c: t·∫Øt greeting, b·∫≠t bgm game
  stopGreetingBgm();
  startGameBgm();

  totalScore=0; won=false; totalScoreEl.textContent='0';
  roundNow=0; perRoundScores.fill(null);
  perRoundAcc.fill(null);
  endScore.style.display = 'none';
  endMessage.style.display = 'none';
  readyBtn.textContent = 'S·∫µn s√†ng ‚ñ∂';
  isEndGame = false;
  renderRoundBarSkeleton(); nextRound();
}
function nextRound(){ roundNow+=1; if(roundNow>10){ finishGame(); return; } roundNowEl.textContent=String(roundNow); lockDraw(); }

/* ===== Round bar ===== */
const rbTop=document.getElementById('rbTop'), rbBot=document.getElementById('rbBot');
function renderRoundBarSkeleton(){
  rbTop.innerHTML = Array.from({length:10},(_,i)=>`<div class="cell">${i+1}</div>`).join('');
  rbBot.innerHTML = Array.from({length:10},(_,i)=>{
    const score = perRoundScores[i] == null ? '‚Äî' : perRoundScores[i];
    const accVal = perRoundAcc[i];
    let className = 'cell';
    if (accVal !== null) {
      if (accVal >= 100) className += ' score-100';
      else if (accVal >= 97) className += ' score-purple';
      else if (accVal >= 95) className += ' score-green';
      else if (accVal >= 90) className += ' score-red';
    }
    return `<div class="${className}">${score}</div>`;
  }).join('');
}
function updateRoundBar(){ renderRoundBarSkeleton(); }

/* ===== Leaderboard ===== */
const LS_NAME='circle_player_name', LS_BOARD='circle_leaderboard_game10';
function getPlayerName(){ return localStorage.getItem(LS_NAME)||''; }
function setPlayerName(n){ localStorage.setItem(LS_NAME,n||''); playerNameEl.textContent=n||'‚Äî'; }
function getBoard(){ try{ return JSON.parse(localStorage.getItem(LS_BOARD)||'[]'); }catch(_){ return []; } }
function setBoard(arr){ localStorage.setItem(LS_BOARD, JSON.stringify(arr)); }
function saveTotalScore(name,total){ const arr=getBoard(); arr.push({name: name, total: Math.round(total), ts: Date.now()}); if(arr.length>300) arr.splice(0,arr.length-300); setBoard(arr); }
function hasNextUnlocked(name){
  if(!name) return false;
  const arr=getBoard(); for(let i=0;i<arr.length;i++){ var it=arr[i]; if(it && it.name===name && it.total>=CONFIG.win.threshold){ return true; } }
  return false;
}
function updateBoard(currentName){
  const arr = getBoard().slice().sort((a,b)=> b.total - a.total || b.ts - a.ts).slice(0,20);
  leaderTable.innerHTML='';
  arr.forEach((it,i)=>{
    const rank=i+1, d=new Date(it.ts);
    const icon=(rank<=3)?`<img class="rankIcon" src="${CONFIG.rankIcons[rank]}" alt="#${rank}"/>`:'';
    const tr=document.createElement('tr'); if(it.name===currentName) tr.classList.add('me');
    tr.innerHTML=`<td>${rank}</td><td>${icon}${it.name}</td><td>${it.total}</td><td>${d.toLocaleString()}</td>`;
    leaderTable.appendChild(tr);
  });
}

/* ===== REST screen ===== */
function updateRestTable(){
  const arr = getBoard().slice().sort((a,b)=> b.total - a.total || b.ts - a.ts).slice(0,50);
  restLeaderBody.innerHTML='';
  arr.forEach((it,i)=>{
    const rank=i+1, d=new Date(it.ts);
    const icon=(rank<=3)?`<img class="rankIcon" src="${CONFIG.rankIcons[rank]}" alt="#${rank}"/>`:'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${rank}</td><td>${icon}${it.name}</td><td>${it.total}</td><td>${d.toLocaleString()}</td>`;
    restLeaderBody.appendChild(tr);
  });
}
function showRestScreen(show=true){
  if(show){
    updateRestTable();
    const ok = hasNextUnlocked(getPlayerName());
    restNextBtn.style.display = ok ? 'inline-block' : 'none';
    restResetBtn.style.display = 'inline-block';
    restLayer.style.display='block';
  } else {
    restLayer.style.display='none';
  }
}
restPracticeBtn.addEventListener('click', ()=>{
  showRestScreen(false);
  showNameModal(true,false);
});
restNextBtn.addEventListener('click', ()=>{
  // S·ª¨A L·ªñI: nh·∫•n l√† hi·ªán ngay, kh√¥ng ph·ª• thu·ªôc state kh√°c
  document.getElementById('devModal').style.display='flex';
});
devClose.addEventListener('click', ()=>{ devModal.style.display='none'; });

/* Reset data */
function resetAllData(){
  try{
    localStorage.removeItem('circle_player_name');
    localStorage.removeItem('circle_leaderboard_game10');
    localStorage.removeItem('circle_win_once');
    localStorage.removeItem('circle_diff_mode');
    localStorage.removeItem('circle_welcome_shown');
    localStorage.removeItem('circle_bgm_vol');
  }catch(e){}
}
restResetBtn.addEventListener('click', ()=>{
  const ok = confirm('Xo√° to√†n b·ªô d·ªØ li·ªáu: T√™n, BXH, win-only, ƒë·ªô kh√≥, welcome, √¢m l∆∞·ª£ng?\nThao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!');
  if (!ok) return;
  resetAllData();
  alert('ƒê√£ reset. Trang s·∫Ω t·∫£i l·∫°i ƒë·ªÉ √°p d·ª•ng.');
  location.reload();
});

/* ===== Modal t√™n (b·∫Øt bu·ªôc & ch∆°i ti·∫øp/d·ª´ng) ===== */
function showNameModal(show=true, again=false){
  nameModal.style.display = show ? 'flex' : 'none';
  if(show){
    modalTitle.textContent = again ? 'Nh·∫≠p t√™n m·ªõi ƒë·ªÉ ch∆°i ti·∫øp' : 'Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu';
    saveNameBtn.textContent = again ? 'Ch∆°i ti·∫øp' : 'B·∫Øt ƒë·∫ßu';
    stopPlayBtn.style.display = again ? 'inline-block' : 'none';
    nameInput.value = '';
    setTimeout(()=> nameInput.focus(),50);
  }
}
saveNameBtn.addEventListener('click', ()=>{
  const n=(nameInput.value||'').trim(); if(!n){ nameInput.focus(); return; }
  setPlayerName(n); updateBoard(n); nameModal.style.display='none'; startGame();
});
stopPlayBtn.addEventListener('click', ()=>{
  nameModal.style.display='none';
  showRestScreen(true);
});

/* ===== K·∫øt th√∫c 10 l∆∞·ª£t ===== */
function finishGame(){
  lockDraw();
  const name=getPlayerName(); if(name){ saveTotalScore(name,totalScore); updateBoard(name); }

  // Hi·ªÉn th·ªã end game UI
  endTotalScore.textContent = totalScore;
  let msg = '';
  if (totalScore < 1000) msg = 'K√©m qu√° b·∫°n ∆°i!';
  else if (totalScore < 1100) msg = 'c≈©ng gh√™ g·ªõm ƒë·∫•y';
  else if (totalScore < 1200) msg = 'Wow ƒë∆∞·ª£c c·ªßa n√≥ ƒë·∫•y s·∫Øp th√†nh t√†i r·ªìi!';
  else if (totalScore < 1300) msg = 'C·ªë l√™n s·∫Øp qua c·ª≠a r·ªìi!';
  else if (totalScore < 1400) msg = 'T·∫ßm n√†y c≈©ng ph·∫£i g·ªçi l√† tr√¨nh ƒë·ªô b·∫≠c th·∫ßy r·ªìi ƒë·∫•y!';
  else if (totalScore < 1500) msg = 'Ti·∫øc qu√°!! Ch·ªâ v√†i % th√¥i....!!!';
  endMessage.textContent = msg;
  endScore.style.display = 'block';
  endMessage.style.display = 'block';
  readyBtn.textContent = 'Ch∆°i game m·ªõi';
  isEndGame = true;
}

/* ===== Welcome (l·∫ßn ƒë·∫ßu) ===== */
const LS_WELCOME='circle_welcome_shown';
function maybeShowWelcome(){
  // Set UI
  welcomeIcon.src = CONFIG.greeting.icon;
  welcomeTitle.textContent = CONFIG.greeting.title || 'Ch√†o m·ª´ng!';
  welcomeText.textContent = CONFIG.greeting.text || '';
  welcome.style.display='flex';

  // Ch·ªâ ·∫©n welcome khi b·∫•m OK (ph√°t nh·∫°c ƒë√£ g·ªçi s·ªõm h∆°n)
}
welcomeOk.addEventListener('click', ()=>{
  welcome.style.display='none';
  localStorage.setItem(LS_WELCOME,'1');
  // M·ªü modal nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu
  showNameModal(true,false);
});

/* ===== Diff UI ===== */
(function initDiffButton(){
  var saved = localStorage.getItem(LS_DIFF);
  if(saved){ setDiffMode(saved); } else { setDiffMode(CONFIG.difficulty.mode); }
  diffToggle.addEventListener('click', function(){
    var m = getDiffMode()==='De' ? 'Thuong' : 'De';
    setDiffMode(m);
  });
})();

/* ===== Kh·ªüi ƒë·ªông ===== */
(function init(){
  document.getElementById('playerName').textContent = '‚Äî';
  renderRoundBarSkeleton();
  scaleCanvas();
  initBgm();

  // Ph√°t greeting BGM NGAY KHI M·ªû TRANG (tr∆∞·ªõc khi show welcome)
  startGreetingBgm();

  // Show Welcome lu√¥n khi v√†o
  maybeShowWelcome();

  // N·∫øu tr∆∞·ªõc ƒë√≥ ƒë√£ c√≥ t√™n (user quay l·∫°i), v·∫´n show welcome
  const n=getPlayerName();
  if(n){ setPlayerName(n); }

  updateBoard(getPlayerName());
})();
</script>
</body>

</html>

